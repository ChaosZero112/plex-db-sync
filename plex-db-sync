#!/bin/bash

ARGC=$#
ARGV=("$@")
COUNT1=0
COUNT2=0

function sqlite_query() {
	if [ ! -n "$1" ];then
		return 1
	fi
	DB=$1
	QUERY=$2
	sqlite3 "$DB" "$QUERY" -line
}

sqlite_read_line () {
    local IFS=" \= "
    read COL DATA
    local ret=$?
    COL_NAME=${COL// /}
    return $ret
}

function sqlite_create_fetch_array() {
	result=$(sqlite_query "$1" "$2")
	if [[ $? -eq 1 ]]; then
		return 1
	fi
	num_rows=0
	unset rows
	declare -Ag rows
	if [[ $result ]]; then
		while sqlite_read_line; do
			if [[ ! $COL_NAME ]];then
				((num_rows=num_rows+1))
			fi
	       	rows[$num_rows,"$COL_NAME"]="$DATA"
		done <<< "$result"
		((num_rows=num_rows+1))
	fi
}

function echoD {
	echo "[`date`] ${@}"
}

function echoDN {
	echo -n "[`date`] ${@}"
}

function sql() {
	if [ "${DEBUG}" == "true" ]; then
		echoD "-=-: $2"
	fi
	sqlite_create_fetch_array "$1" "$2"
}

function setnull() {
	tmpvar="'${1}'"
	if [ "$tmpvar" == "''" ]; then
		tmpvar="null"
	fi
	echo $tmpvar
}

function initSql() {
	echo "PRAGMA journal_mode=WAL;" > "${PLEXF1}"
	echo "PRAGMA wal_checkpoint;" >> "${PLEXF1}"
	echo "PRAGMA journal_mode=WAL;" > "${PLEXF2}"
	echo "PRAGMA wal_checkpoint;" >> "${PLEXF2}"
}

function echoSql() {
	if [ "${DEBUG}" == "true" ]; then
		echoD "${1}: ${2}"
	fi
	echo "${2}" >> "${1}"
}

function closeSql() {
	echo "PRAGMA wal_checkpoint;" >> "${PLEXF1}"
	echo "PRAGMA wal_checkpoint;" >> "${PLEXF2}"
}

function checkDependencies() {
	if [ -z "$(which sqlite3)" ]; then
		echoD "Missing dependency: sqlite3"
		exit
	fi
	if [ -z "$(which sshfs)" ]; then
		echoD "Missing dependency: sshfs"
		exit
	fi
}

function checkForDBs() {
	if [ ! -f "$PLEXDB1" ]; then
		echoD "Server 1 DB not found"
		exit
	fi
	if [ ! -f "$PLEXDB2" ]; then
		echoD "Server 2 DB not found"
		exit
	fi
}

function initFS() {
	if [ ! -d "$TMPFOLDER" ]; then
		mkdir -p "$TMPFOLDER"
	else
		if [ -n "${TMPFOLDER}" ]; then
			rm -rf "${TMPFOLDER}/"*
		fi
	fi
	MOUNTED=$(mount |grep ramfs |grep "${TMPFOLDER}")
	if [ -z "$MOUNTED" ]; then
		mount -t ramfs ramfs "$TMPFOLDER"
	fi
}

function closeFS() {
	if [ -n "${TMPFOLDER}" ]; then
		rm -rf "${TMPFOLDER}/"*
	fi
	MOUNTED=$(mount |grep ramfs |grep "${TMPFOLDER}")
	if [ -n "$MOUNTED" ]; then
		umount "${TMPFOLDER}"
	fi
}

function getIgnore() {
	IGNORESTR=""
	if [ -n "$1" ]; then
		OLDIFS=$IFS
		IFS=","
		for ACCOUNT in $1; do
			if [ -z "$IGNORESTR" ]; then
				IGNORESTR="${IGNORESTR}lower('${ACCOUNT}')"
			else
				IGNORESTR="${IGNORESTR},lower('${ACCOUNT}')"
			fi
		done
		IGNORESTR="${IGNORESTR},''"
		IFS=$OLDIFS
	else
		IGNORESTR='';
	fi
	echo $IGNORESTR
}

function createTmpDB() {
	echo 'CREATE TABLE "metadata_item_settings1" ("id" INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, "account_id" integer, "guid" varchar(255), "rating" float, "view_offset" integer, "view_count" integer, "last_viewed_at" datetime, "created_at" datetime, "updated_at" datetime, 'skip_count' integer DEFAULT 0, 'last_skipped_at' datetime DEFAULT NULL, 'changed_at' integer(8) default '0', 'extra_data' varchar(255));' | sqlite3 "${TMPDB}"
	echo 'CREATE TABLE "metadata_item_settings2" ("id" INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, "account_id" integer, "guid" varchar(255), "rating" float, "view_offset" integer, "view_count" integer, "last_viewed_at" datetime, "created_at" datetime, "updated_at" datetime, 'skip_count' integer DEFAULT 0, 'last_skipped_at' datetime DEFAULT NULL, 'changed_at' integer(8) default '0', 'extra_data' varchar(255));' | sqlite3 "${TMPDB}"
	echo 'CREATE TABLE "metadata_items1" ("id" INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, "library_section_id" integer, "parent_id" integer, "metadata_type" integer, "guid" varchar(255), "media_item_count" integer, "title" varchar(255), "title_sort" varchar(255) COLLATE NOCASE, "original_title" varchar(255), "studio" varchar(255), "rating" float, "rating_count" integer, "tagline" varchar(255), "summary" text, "trivia" text, "quotes" text, "content_rating" varchar(255), "content_rating_age" integer, "index" integer, "absolute_index" integer, "duration" integer, "user_thumb_url" varchar(255), "user_art_url" varchar(255), "user_banner_url" varchar(255), "user_music_url" varchar(255), "user_fields" varchar(255), "tags_genre" varchar(255), "tags_collection" varchar(255), "tags_director" varchar(255), "tags_writer" varchar(255), "tags_star" varchar(255), "originally_available_at" datetime, "available_at" datetime, "expires_at" datetime, "refreshed_at" datetime, "year" integer, "added_at" datetime, "created_at" datetime, "updated_at" datetime, "deleted_at" datetime, "tags_country" varchar(255), "extra_data" varchar(255), "hash" varchar(255), "audience_rating" float, "changed_at" integer(8) DEFAULT 0, "resources_changed_at" integer(8) DEFAULT 0);' | sqlite3 "${TMPDB}"
	echo 'CREATE TABLE "metadata_items2" ("id" INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, "library_section_id" integer, "parent_id" integer, "metadata_type" integer, "guid" varchar(255), "media_item_count" integer, "title" varchar(255), "title_sort" varchar(255) COLLATE NOCASE, "original_title" varchar(255), "studio" varchar(255), "rating" float, "rating_count" integer, "tagline" varchar(255), "summary" text, "trivia" text, "quotes" text, "content_rating" varchar(255), "content_rating_age" integer, "index" integer, "absolute_index" integer, "duration" integer, "user_thumb_url" varchar(255), "user_art_url" varchar(255), "user_banner_url" varchar(255), "user_music_url" varchar(255), "user_fields" varchar(255), "tags_genre" varchar(255), "tags_collection" varchar(255), "tags_director" varchar(255), "tags_writer" varchar(255), "tags_star" varchar(255), "originally_available_at" datetime, "available_at" datetime, "expires_at" datetime, "refreshed_at" datetime, "year" integer, "added_at" datetime, "created_at" datetime, "updated_at" datetime, "deleted_at" datetime, "tags_country" varchar(255), "extra_data" varchar(255), "hash" varchar(255), "audience_rating" float, "changed_at" integer(8) DEFAULT 0, "resources_changed_at" integer(8) DEFAULT 0);' | sqlite3 "${TMPDB}"
	echo "attach '${PLEXDB1}' as plexdb; attach '${TMPDB}' as tmpdb; insert into tmpdb.metadata_item_settings1 select * from plexdb.metadata_item_settings;" | sqlite3
	echo "attach '${PLEXDB2}' as plexdb; attach '${TMPDB}' as tmpdb; insert into tmpdb.metadata_item_settings2 select * from plexdb.metadata_item_settings;" | sqlite3
	echo "attach '${PLEXDB1}' as plexdb; attach '${TMPDB}' as tmpdb; insert into tmpdb.metadata_items1 select * from plexdb.metadata_items;" | sqlite3
	echo "attach '${PLEXDB2}' as plexdb; attach '${TMPDB}' as tmpdb; insert into tmpdb.metadata_items2 select * from plexdb.metadata_items;" | sqlite3
}

function processCommon() {
	sql "${TMPDB}" "select s1.guid, s1.id as id1, s1.updated_at as updated_at1, s1.view_count as view_count1, s1.last_viewed_at as last_viewed_at1, s1.view_offset as view_offset1, s1.changed_at as changed_at1, s2.id as id2, s2.updated_at as updated_at2, s2.view_count as view_count2, s2.last_viewed_at as last_viewed_at2, s2.view_offset as view_offset2, s2.changed_at as changed_at2 from metadata_item_settings1 s1, metadata_item_settings2 s2 where s1.guid=s2.guid and s1.account_id=s2.account_id and s1.account_id=${1} and (s1.view_count != s2.view_count or s1.last_viewed_at != s2.last_viewed_at or s1.view_offset != s2.view_offset or s1.changed_at != s2.changed_at);"
	for (( i = 0; i < num_rows; i++ )); do
		# Which record is newer?
		updated_at1_int=$(date -d "${rows[$i,"updated_at1"]}" +%s)
		updated_at2_int=$(date -d "${rows[$i,"updated_at2"]}" +%s)
		if [ ${updated_at1_int} -ge ${updated_at2_int} ] || [ ${rows[$i,"changed_at1"]} -ge ${rows[$i,"changed_at2"]} ]; then
			# Server 1 is newer
			echoD "    - (${i}/${num_rows}) Setting server 2 status for: ${rows[$i,"guid"]}"
			last_viewed_at=$(setnull "${rows[$i,"last_viewed_at1"]}")
			view_offset=$(setnull "${rows[$i,"view_offset1"]}")
			echoSql "${PLEXF2}" "update metadata_item_settings set updated_at='${rows[$i,"updated_at1"]}', view_count=${rows[$i,"view_count1"]}, last_viewed_at=${last_viewed_at}, view_offset=${view_offset}, changed_at=${rows[$i,"changed_at1"]} where id=${rows[$i,"id2"]};"
			((COUNT2++))
		else
			# Server 2 is newer
			echoD "    - (${i}/${num_rows}) Setting server 1 status for: ${rows[$i,"guid"]}"
			last_viewed_at=$(setnull "${rows[$i,"last_viewed_at2"]}")
			view_offset=$(setnull "${rows[$i,"view_offset2"]}")
			echoSql "${PLEXF1}" "update metadata_item_settings set updated_at='${rows[$i,"updated_at2"]}', view_count=${rows[$i,"view_count2"]}, last_viewed_at=${last_viewed_at}, view_offset=${view_offset}, changed_at=${rows[$i,"changed_at2"]} where id=${rows[$i,"id1"]};"
			(( COUNT1++ ));
		fi
	done
}

function processNew() {
	sql "${TMPDB}" "select * from metadata_item_settings${3} where guid in (select guid from metadata_items${4}) and guid not in (select guid from metadata_item_settings${4} where account_id=${1}) and account_id=${1};"
	for (( i = 0; i < num_rows; i++ )); do
		echoD "    - (${i}/${num_rows}) Setting server ${4} status for: ${rows[$i,"guid"]}"
		rating=$(setnull "${rows[$i,"rating"]}")
		view_offset=$(setnull "${rows[$i,"view_offset"]}")
		last_viewed_at=$(setnull "${rows[$i,"last_viewed_at"]}")
		skip_count=$(setnull "${rows[$i,"skip_count"]}")
		last_skipped_at=$(setnull "${rows[$i,"last_skipped_at"]}")
		extra_data=$(setnull "${rows[$i,"extra_data"]}")
		echoSql "${2}" "insert into metadata_item_settings (account_id, guid, rating, view_offset, view_count, last_viewed_at, created_at, updated_at, skip_count, last_skipped_at, changed_at, extra_data) values ('${1}', '${rows[$i,"guid"]}', ${rating}, ${view_offset}, '${rows[$i,"view_count"]}', ${last_viewed_at}, '${rows[$i,"created_at"]}', '${rows[$i,"updated_at"]}', ${skip_count}, ${last_skipped_at}, ${rows[$i,"changed_at"]}, ${extra_data});"
		if [ ${4} -eq 2 ]; then
			((COUNT2++))
		else
			((COUNT1++))
		fi
	done
}

function getConfig() {
	V=""
	for (( j=0; j<ARGC; j++ )); do
		if [ "${ARGV[j]}" == "${1}" ]; then
			V="${ARGV[j+1]}"
			break;
		fi
	done
	if [ -z "${V}" ]; then
		V="${2}"
	fi
	echo "${V}"
}

function checkRequired() {
	V=$(getConfig "${1}" "")
	if [ -z "${V}" ]; then
		echoD "Error: ${1} is a required flag"
		showUsage
		exit
	fi
}

function updateServers() {
	if [ $COUNT1 -gt 0 ]; then
		if [ -n "${PLEXSTOP1}" ]; then
			echoDN "Stopping Plex on Server 1..."
			eval ${PLEXSTOP1} 1> /dev/null 2>&1
			echoD "Done"
		fi
		if [ "${BACKUP}" == "true" ]; then
			runBackup "${PLEXDB1}"
		fi
		file2sql "${PLEXDB1}" "${PLEXF1}"
		if [ -n "${PLEXSTART1}" ]; then
			echoDN "Starting Plex on Server 1..."
			eval ${PLEXSTART1} 1> /dev/null 2>&1
			echoD "Done"
		fi
	fi
	if [ $COUNT2 -gt 0 ]; then
		if [ -n "${PLEXSTOP2}" ]; then
			echoDN "Stopping Plex on Server 2..."
			eval ${PLEXSTOP2} 1> /dev/null 2>&1
			echoD "Done"
		fi
		if [ "${BACKUP}" == "true" ]; then
			runBackup "${PLEXDB2}"
		fi
		file2sql "${PLEXDB2}" "${PLEXF2}"
		if [ -n "${PLEXSTART2}" ]; then
			echoDN "Starting Plex on Server 2..."
			eval ${PLEXSTART2} 1> /dev/null 2>&1
			echoD "Done"
		fi
	fi
}

function file2sql() {
	if [ "$DRYRUN" == false ]; then
		echoD "Applying DB changes to ${1}..."
		sqlite3 "$1" < "$2"
	else
		echoD "(DRY RUN) Applying DB changes to ${1}..."
	fi
}

function runBackup() {
	echoD "Backing up ${1}..."
	cp -a "${1}" "${1}.dbsyc.bak"
}

function printConfig() {
	if [ "${DEBUG}" == "true" ]; then
		echoD "TMPFOLDER: ${TMPFOLDER}"
		echoD "DEBUG: ${DEBUG}"
		echoD "PLEXDB1: ${PLEXDB1}"
		echoD "PLEXDB2: ${PLEXDB2}"
		echoD "PLEXSTART1: ${PLEXSTART1}"
		echoD "PLEXSTOP1: ${PLEXSTOP1}"
		echoD "PLEXSTART2: ${PLEXSTART2}"
		echoD "PLEXSTOP2: ${PLEXSTOP2}"
		echoD "PLEXF1: ${PLEXF1}"
		echoD "PLEXF2: ${PLEXF2}"
		echoD "TMPDB: ${TMPDB}"
		echoD "IGNORE: ${IGNORE}"
		echoD "IGNORESTR: ${IGNORESTR}"
		echoD "BACKUP: ${BACKUP}"
	fi
}

function showUsage() {
	echoD "Usage: ./plex-db-sync.sh --dry-run <true/false> --backup <true/false> --debug <true/false> --plex-db-1 <path/to/database.db (r)> --plex-db-2 <path/to/database.db (r)> --plex-start-1 <command to start plex (r)> --plex-stop-1 <command to stop plex (r)> --plex-start-2 <command to start plex (r)> --plex-stop-2 <command to stop plex (r)> --ignore-accounts <Account1,Account2> --tmp-folder </tmp/plex-db-sync>"
}

function checkForNew() {
	#return 0
	UP1=$(echo "select updated_at from metadata_item_settings order by updated_at desc limit 1;" | sqlite3 "${PLEXDB1}")
	UP2=$(echo "select updated_at from metadata_item_settings order by updated_at desc limit 1;" | sqlite3 "${PLEXDB2}")
	if [ "$DEBUG" == "true" ]; then
		echoD "UP1: $UP1 - UP2: $UP2"
	fi
	if [ "${UP1}" != "${UP2}" ]; then
		return 0
	fi
	CH1=$(echo "select changed_at from metadata_item_settings order by changed_at desc limit 1;" | sqlite3 "${PLEXDB1}")
	CH2=$(echo "select changed_at from metadata_item_settings order by changed_at desc limit 1;" | sqlite3 "${PLEXDB2}")
	if [ "$DEBUG" == "true" ]; then
		echoD "CH1: $CH1 - CH2: $CH2"
	fi
	if [ "${CH1}" != "${CH2}" ]; then
		return 0
	fi
	return 1
}

echoD "Starting."
checkDependencies
TMPFOLDER=$(getConfig "--tmp-folder" "/tmp/plex-db-sync")
DEBUG=$(getConfig "--debug" "false")
BACKUP=$(getConfig "--backup" "false")
DRYRUN=$(getConfig "--dry-run" "false")
PLEXDB1=$(getConfig "--plex-db-1" "")
PLEXDB2=$(getConfig "--plex-db-2" "")
PLEXSTART1=$(getConfig "--plex-start-1" "")
PLEXSTOP1=$(getConfig "--plex-stop-1" "")
PLEXSTART2=$(getConfig "--plex-start-2" "")
PLEXSTOP2=$(getConfig "--plex-stop-2" "")
IGNORE=$(getConfig "--ignore-accounts" "")
PLEXF1="${TMPFOLDER}/1.sql"
PLEXF2="${TMPFOLDER}/2.sql"
TMPDB="${TMPFOLDER}/tmp.db"
IGNORESTR=$(getIgnore "$IGNORE")
checkRequired "--plex-db-1"
checkRequired "--plex-db-2"
checkRequired "--plex-start-1"
checkRequired "--plex-start-2"
checkRequired "--plex-stop-1"
checkRequired "--plex-stop-2"
printConfig
checkForDBs

echoDN "Checking for changes... "
if checkForNew; then
	echo "Found"
	initFS
	initSql
	createTmpDB

	# Get accounts on server 1
	sql "$PLEXDB1" "select id, name from accounts where lower(name) not in (${IGNORESTR}) order by id;"
	rowstr=$(declare -p rows)
	eval "declare -A accounts1="${rowstr#*=}
	num_accounts1=$num_rows

	# Get accounts on server 2
	sql "$PLEXDB2" "select id, name from accounts where lower(name) not in (${IGNORESTR}) order by id;"
	rowstr=$(declare -p rows)
	eval "declare -A accounts2="${rowstr#*=}
	num_accounts2=$num_rows

	for (( a1 = 0; a1 < num_accounts1; a1++ )); do
		for (( a2 = 0; a2 < num_accounts2; a2++ )); do
			# If a match, process
			if [ "${accounts1[$a1,"id"]}" == "${accounts2[$a2,"id"]}" ]; then
				echoD "Processing for ${accounts1[$a1,"name"]} (${accounts1[$a1,"id"]})..."

				# Start with records that are in both tables
				echoD "  - Checking records that are in both databases"
				processCommon ${accounts1[$a1,"id"]}

				# Then look at records that are on one server but not the other
				# We will start with server 1
				echoD "  - Checking records missing from server 2"
				processNew ${accounts1[$a1,"id"]} "${PLEXF2}" 1 2

				# And then server 2
				echoD "  - Checking records missing from server 1"
				processNew ${accounts1[$a1,"id"]} "${PLEXF1}" 2 1
			fi
		done
	done

	closeSql
	updateServers
	closeFS
else
	echo "None found"
fi
echoD "Finished."
